#!/bin/sh
# ping_sweep - OpenWrt compatible (busybox/ash)
# Salva come /usr/bin/ping_sweep (senza estensione) e rendilo eseguibile.
# Uso: ping_sweep
# Config: /usr/lib/TelegramWrt/config (TOKEN="..." and CHAT_ID="...")

CONFIG="/usr/lib/TelegramWrt/config"
SUBNET="192.168.1"       # modifica se necessario
TIMEOUT="${TIMEOUT:-1}"   # UT=1
CONCURRENCY="${CONCURRENCY:-64}"  # numero max di ping paralleli
OUTFILE="/tmp/ping_sweep_up.txt"

# Inizializza output
: > "$OUTFILE"

# Legge TOKEN e CHAT_ID dal file di configurazione (se presente)
TOKEN=""
CHAT_ID=""
if [ -r "$CONFIG" ]; then
  # rimuove eventuali virgolette
  TOKEN=$(awk -F= '/^TOKEN=/{gsub(/^[ \t"]+|[ \t"]+$/,"",$2); print $2}' "$CONFIG" 2>/dev/null || true)
  CHAT_ID=$(awk -F= '/^CHAT_ID=/{gsub(/^[ \t"]+|[ \t"]+$/,"",$2); print $2}' "$CONFIG" 2>/dev/null || true)
fi

# Funzione ping (1..254) con limite di concorrenza semplice
do_ping() {
  ip="$1"
  # busybox ping uses -c and -W (timeout seconds)
  if ping -c 1 -W "$TIMEOUT" "$ip" >/dev/null 2>&1; then
    echo "$ip" >> "$OUTFILE"
  fi
}

# Sweep con controllo concorrenza
running=0
i=1
while [ "$i" -le 254 ]; do
  do_ping "${SUBNET}.$i" &
  running=$((running + 1))

  if [ "$running" -ge "$CONCURRENCY" ]; then
    wait
    running=0
  fi

  i=$((i + 1))
done

# aspetta eventuali rimanenti
wait

# Conteggio host up (opzionale)
UP_COUNT=0
if [ -s "$OUTFILE" ]; then
  UP_COUNT=$(wc -l < "$OUTFILE" 2>/dev/null || echo 0)
fi

# Invio messaggio Telegram solo se token e chat_id sono presenti
if [ -n "$TOKEN" ] && [ -n "$CHAT_ID" ]; then
  # testo con emoji
  TEXT="âœ… Scansione ping completata!%0AHost up: <b>${UP_COUNT}</b>"

  curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
       -d chat_id="${CHAT_ID}" \
       -d parse_mode="HTML" \
       -d text="$TEXT" >/dev/null 2>&1 || true
fi

# Messaggio finale su stdout come nel tuo originale
echo "Ping sweep completed successfully. Host up: $UP_COUNT."

