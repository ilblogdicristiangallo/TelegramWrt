#!/bin/sh

INTERFACE="br-lan"
DURATION="$1"
PCAP="/tmp/dns_capture.pcap"

# Validate input
if [ -z "$DURATION" ] || ! echo "$DURATION" | grep -Eq '^[0-9]+$'; then
  echo "‚ö†Ô∏è Error: use /tcpdump_dns <seconds> with a valid number (e.g. /tcpdump_dns 10)"
  exit 0
fi

# Capture DNS traffic
tcpdump -i "$INTERFACE" port 53 -w "$PCAP" -G "$DURATION" -W 1 >/dev/null 2>&1

# Analyze results
if [ -s "$PCAP" ]; then
  OUTPUT=$(tcpdump -nn -r "$PCAP" port 53 2>/dev/null | grep "A?" | awk '
  {
    sub("\\.[0-9]+$", "", $3);
    sub("\\.53:$", "", $5);
    print "Client: " $3 "\nDNS: " $5 "\nDomain: " $8 "\n---"
  }')

  if [ -n "$OUTPUT" ]; then
    echo "üì° DNS queries detected on $INTERFACE during the last $DURATION seconds:\n$OUTPUT"
  else
    echo "‚ö†Ô∏è No DNS queries detected on $INTERFACE during the last $DURATION seconds."
  fi
else
  echo "‚ö†Ô∏è No DNS queries detected on $INTERFACE during the last $DURATION seconds."
fi

# Cleanup
rm -f "$PCAP" >/dev/null 2>&1

