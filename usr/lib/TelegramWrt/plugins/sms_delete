#!/bin/sh

PORTS="/dev/ttyUSB1 /dev/ttyUSB2"
LOG="/var/log/sms_dispatcher.log"
TMP="/tmp/sms_delete.$$"
COUNT=0
DELETED=0

echo "ðŸ—‘ï¸ SMS deletion in progress:" > "$TMP"

for DEVICE in $PORTS; do
    RAW=$(sms_tool -d "$DEVICE" -s MT recv 2>/dev/null)
    MSG_COUNT=$(echo "$RAW" | grep -c "^MSG:")

    if [ "$MSG_COUNT" -gt 0 ]; then
        sms_tool -d "$DEVICE" -s MT delete all >/dev/null 2>&1
        if [ $? -eq 0 ]; then
            TIME=$(date '+%Y-%m-%d %H:%M:%S')
            echo "[$TIME] Deleted $MSG_COUNT SMS on $DEVICE" >> "$LOG"
            echo "[$TIME] âœ… Deleted $MSG_COUNT SMS on $DEVICE" >> "$TMP"
            DELETED=$((DELETED + MSG_COUNT))
            COUNT=$((COUNT + 1))
        else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] âš ï¸ Failed to delete SMS on $DEVICE" >> "$TMP"
        fi
    else
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] â„¹ï¸ No SMS found on $DEVICE" >> "$TMP"
    fi
done

if [ "$DELETED" -gt 0 ]; then
    echo "---" >> "$TMP"
    echo "âœ… Total deleted messages: $DELETED from $COUNT modem(s)." >> "$TMP"
else
    echo "âŒ No messages to delete. All modems are already clean." >> "$TMP"
fi

cat "$TMP"
rm -f "$TMP"
exit 0

