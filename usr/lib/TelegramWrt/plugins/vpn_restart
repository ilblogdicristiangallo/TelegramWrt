#!/bin/sh
# Plugin /vpn_restart for TelegramWrt

LOG="/var/log/vpn_control.log"
TIME=$(date '+%Y-%m-%d %H:%M:%S')

VPN_IFACES=$(uci show network | grep "=interface" | grep -Ei '\.wg[0-9]*|\.tun[0-9]*|\.vpn|\.ovpn|\.openvpn' | cut -d. -f2 | cut -d= -f1 | sort -u)

if [ -z "$VPN_IFACES" ]; then
    echo "âŒ No VPN interfaces found. Nothing to restart."
    echo "[$TIME] âŒ No VPN interfaces found in UCI" >> "$LOG"
    exit 1
fi

echo "ðŸ”„ Restarting VPN interfaces:"
for IFACE in $VPN_IFACES; do
    ifdown "$IFACE"
    sleep 2
    ifup "$IFACE"
    if [ $? -eq 0 ]; then
        echo "âœ… $IFACE restarted successfully"
        echo "[$TIME] ðŸ” Interface '$IFACE' restarted successfully" >> "$LOG"
    else
        echo "âš ï¸ Error restarting $IFACE"
        echo "[$TIME] âš ï¸ Error restarting interface '$IFACE'" >> "$LOG"
    fi
done

exit 0
